<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Orbit - Find the Missing Link</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Work+Sans:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">
    <style>
        :root {
            /* Bitly Brand Colors */
            --navy: #031f39;
            --orange: #f36600;
            --base-01: #fffdf8;
            --blue-dark: #219acd;
            --blue-light: #4fcaff;
            --green-dark: #257640;
            --green-light: #96de94;
            --orange-dark: #b6420d;
            --orange-light: #ff950a;
            --red-dark: #c32813;
            --red-light: #ef5b46;
            --yellow-dark: #e09600;
            --yellow-light: #ffbf3c;
            --base-03: #eeeae3;
            --base-04: #d6d2c9;
            --base-05: #bab7b0;
            --base-07: #777570;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Work Sans', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: var(--base-01);
            color: var(--navy);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 10px;
        }

        header {
            text-align: center;
            margin-bottom: 20px;
            width: 100%;
        }

        h1 {
            font-size: 2.5rem;
            color: var(--orange);
            margin-bottom: 5px;
            font-weight: 700;
            letter-spacing: -0.5px;
        }

        .bitly-credit {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            color: var(--base-07);
            font-size: 0.8rem;
            margin-bottom:20px;
            margin-top:-8px;
        }

        .bitly-logo {
            width: 36px;
            margin-bottom: -5px;
        }

        .subtitle {
            color: var(--base-07);
            font-size: 0.9rem;
            margin-bottom: 15px;
        }

        .puzzle-number {
            color: var(--navy);
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .game-container {
            width: 100%;
            max-width: 500px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            flex: 1;
        }

        .puzzle-display {
            background: white;
            border: 2px solid var(--base-03);
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .word-pair {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            font-size: 1.2rem;
            font-weight: 600;
        }

        .word {
            display: flex;
            gap: 3px;
        }

        .letter-box {
            width: 30px;
            height: 30px;
            border: 2px solid var(--base-04);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            text-transform: uppercase;
            background: white;
            font-size: 0.9rem;
        }

        .letter-box.filled {
            background: var(--navy);
            color: white;
            border-color: var(--navy);
        }

        .letter-box.empty {
            background: var(--base-03);
            border-style: dashed;
        }

        .connector {
            color: var(--base-05);
            font-size: 0.8rem;
            font-weight: 400;
        }

        .board-container {
            display: flex;
            flex-direction: column;
            gap: 0;
            margin-bottom: 20px;
        }

        .guess-row-container {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-bottom: 5px;
        }

        .guess-row {
            display: flex;
            gap: 5px;
        }

        .orbit-letters {
            display: flex;
            gap: 3px;
            opacity: 0.6;
        }

        .orbit-letter {
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
            font-weight: 600;
            text-transform: uppercase;
            color: var(--base-07);
        }

        .tile {
            width: 45px;
            height: 45px;
            border: 2px solid var(--base-04);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            font-weight: 700;
            text-transform: uppercase;
            transition: all 0.2s;
            background: white;
        }

        .tile.filled {
            border-color: var(--base-07);
            animation: pop 0.1s ease-in-out;
        }

        .tile.correct {
            background: var(--green-dark) !important;
            color: white !important;
            border-color: var(--green-dark) !important;
            animation: flip 0.8s ease-in-out;
        }

        .tile.present {
            background: var(--yellow-dark) !important;
            color: white !important;
            border-color: var(--yellow-dark) !important;
            animation: flip 0.8s ease-in-out;
        }

        .tile.absent {
            background: var(--base-05) !important;
            color: white !important;
            border-color: var(--base-05) !important;
            animation: flip 0.8s ease-in-out;
        }

        @keyframes pop {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        @keyframes flip {
            0% { transform: rotateX(0); }
            50% { transform: rotateX(90deg); }
            100% { transform: rotateX(0); }
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-3px); }
            20%, 40%, 60%, 80% { transform: translateX(3px); }
        }

        .keyboard {
            display: flex;
            flex-direction: column;
            gap: 8px;
            width: 100%;
            max-width: 500px;
            margin-top: auto;
        }

        .keyboard-row {
            display: flex;
            justify-content: center;
            gap: 6px;
        }

        .key {
            padding: 0;
            font-size: 1rem;
            font-weight: 600;
            border: none;
            border-radius: 4px;
            background: var(--base-04);
            color: var(--navy);
            cursor: pointer;
            text-transform: uppercase;
            min-width: 30px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.1s;
            flex: 1;
            max-width: 45px;
        }

        .key:active {
            transform: scale(0.95);
        }

        .key.wide {
            max-width: 65px;
            font-size: 0.8rem;
        }

        .key.correct {
            background: var(--green-dark);
            color: white;
        }

        .key.present {
            background: var(--yellow-dark);
            color: white;
        }

        .key.absent {
            background: var(--base-07);
            color: white;
        }

        .message {
            position: fixed;
            top: 80px;
            left: 50%;
            transform: translateX(-50%);
            padding: 10px 20px;
            border-radius: 4px;
            font-weight: 500;
            z-index: 1000;
            animation: slideDown 0.3s ease-out;
        }

        @keyframes slideDown {
            from { transform: translate(-50%, -100%); opacity: 0; }
            to { transform: translate(-50%, 0); opacity: 1; }
        }

        .message.error {
            background: var(--red-light);
            color: white;
        }

        .message.success {
            background: var(--green-light);
            color: var(--green-dark);
        }

        .message.info {
            background: var(--blue-light);
            color: var(--blue-dark);
        }

        .help-button {
            background: none;
            border: 2px solid var(--orange);
            color: var(--orange);
            padding: 8px 16px;
            font-size: 0.9rem;
            font-weight: 600;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
            margin-top: 10px;
        }

        .help-button:hover {
            background: var(--orange);
            color: white;
        }

        .results-button {
            background: var(--blue-dark);
            color: white;
            border: none;
            padding: 8px 12px;
            font-size: 1.2rem;
            font-weight: 600;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
            margin-left: 10px;
            margin-top: 10px;
            min-width: 40px;
            height: 36px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            vertical-align: bottom;
        }

        .results-button:hover {
            background: var(--blue-light);
        }

        .results-button:disabled {
            background: var(--base-05);
            cursor: not-allowed;
        }

        .chart-icon {
            width: 16px;
            height: 16px;
            fill: currentColor;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 8px;
            text-align: center;
            max-width: 400px;
            margin: 20px;
        }

        .modal h2 {
            color: var(--orange);
            margin-bottom: 20px;
        }

        .modal button {
            background: var(--orange);
            color: white;
            border: none;
            padding: 10px 20px;
            font-size: 1rem;
            font-weight: 600;
            border-radius: 4px;
            cursor: pointer;
            margin: 10px 5px;
        }

        .modal button:hover {
            background: var(--orange-dark);
        }

        .modal button.secondary {
            background: var(--base-04);
            color: var(--navy);
        }

        .modal button.secondary:hover {
            background: var(--base-05);
        }

        .close-button {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--base-07);
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .close-button:hover {
            color: var(--navy);
        }

        .instructions {
            text-align: left;
            margin: 20px 0;
            line-height: 1.1;
        }

        .instructions ul {
            margin: 15px 0;
            padding-left: 20px;
        }

        .instructions li {
            margin: 10px 0;
        }

        .color-example {
            display: inline-block;
            width: 20px;
            height: 20px;
            border-radius: 3px;
            vertical-align: middle;
            margin-right: 5px;
        }

        .color-example.green {
            background: var(--green-dark);
        }

        .color-example.yellow {
            background: var(--yellow-dark);
        }

        .color-example.gray {
            background: var(--base-05);
        }

        .share-result {
            background: white;
            border: 1px solid var(--base-04);
            border-radius: 4px;
            padding: 15px;
            margin: 15px 0;
            font-family: monospace;
            white-space: pre;
            text-align: left;
            font-size: 0.9rem;
            line-height: 1.4;
        }

        @media (max-width: 480px) {
            .tile {
                width: 35px;
                height: 35px;
                font-size: 1rem;
            }
            
            .orbit-letter {
                width: 25px;
                height: 25px;
                font-size: 0.8rem;
            }
            
            .key {
                min-width: 25px;
                height: 45px;
                font-size: 0.9rem;
            }
            
            .word-pair {
                gap: 10px;
            }
            
            .letter-box {
                width: 25px;
                height: 25px;
                font-size: 0.8rem;
            }
        }
    </style>
</head>
<body>
    <header>
        <h1>ORBIT</h1>
        <div class="bitly-credit">
            <span>a</span>
            <img class="bitly-logo" src="bitly.svg" alt="bitly" onerror="this.src='bitly.png'">
            <span>game</span>
        </div>
        <p class="subtitle">Find the missing link between two words!</p>
        <div class="puzzle-number" id="puzzleNumber">Puzzle #1001</div>
        <div>
            <button class="help-button" onclick="showHowToPlay()">How to Play</button>
            <button class="results-button" id="viewResultsButton" onclick="showResults()" disabled title="View Results">
                <svg class="chart-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512">
                    <path d="M160 80c0-26.5 21.5-48 48-48l32 0c26.5 0 48 21.5 48 48l0 352c0 26.5-21.5 48-48 48l-32 0c-26.5 0-48-21.5-48-48l0-352zM0 272c0-26.5 21.5-48 48-48l32 0c26.5 0 48 21.5 48 48l0 160c0 26.5-21.5 48-48 48l-32 0c-26.5 0-48-21.5-48-48L0 272zM368 96l32 0c26.5 0 48 21.5 48 48l0 288c0 26.5-21.5 48-48 48l-32 0c-26.5 0-48-21.5-48-48l0-288c0-26.5 21.5-48 48-48z"/>
                </svg>
            </button>
        </div>
    </header>
    
    <div class="game-container">
        <div class="puzzle-display">
            <div class="word-pair">
                <div class="word" id="leftWord"></div>
                <span class="connector">and</span>
                <div class="word" id="rightWord"></div>
            </div>
        </div>
        
        <div class="board-container" id="board"></div>
        
        <div class="keyboard">
            <div class="keyboard-row">
                <button class="key" data-key="Q">Q</button>
                <button class="key" data-key="W">W</button>
                <button class="key" data-key="E">E</button>
                <button class="key" data-key="R">R</button>
                <button class="key" data-key="T">T</button>
                <button class="key" data-key="Y">Y</button>
                <button class="key" data-key="U">U</button>
                <button class="key" data-key="I">I</button>
                <button class="key" data-key="O">O</button>
                <button class="key" data-key="P">P</button>
            </div>
            <div class="keyboard-row">
                <button class="key" data-key="A">A</button>
                <button class="key" data-key="S">S</button>
                <button class="key" data-key="D">D</button>
                <button class="key" data-key="F">F</button>
                <button class="key" data-key="G">G</button>
                <button class="key" data-key="H">H</button>
                <button class="key" data-key="J">J</button>
                <button class="key" data-key="K">K</button>
                <button class="key" data-key="L">L</button>
            </div>
            <div class="keyboard-row">
                <button class="key wide" data-key="Enter">ENTER</button>
                <button class="key" data-key="Z">Z</button>
                <button class="key" data-key="X">X</button>
                <button class="key" data-key="C">C</button>
                <button class="key" data-key="V">V</button>
                <button class="key" data-key="B">B</button>
                <button class="key" data-key="N">N</button>
                <button class="key" data-key="M">M</button>
                <button class="key wide" data-key="Backspace">⌫</button>
            </div>
        </div>
    </div>

    <div id="gameOverModal" class="modal">
        <div class="modal-content">
            <button class="close-button" onclick="closeResults()">×</button>
            <h2 id="modalTitle">Better luck next time!</h2>
            <p id="modalMessage"></p>
            <div class="share-result" id="shareResult" style="display: none;"></div>
            <button onclick="shareResult()" id="shareButton" style="display: none;">Share Result</button>
            <button onclick="newGame()">New Game</button>
            <button class="secondary" onclick="closeResults()">Close</button>
        </div>
    </div>

    <div id="howToPlayModal" class="modal">
        <div class="modal-content">
            <button class="close-button" onclick="closeHowToPlay()">×</button>
            <h2>How to Play</h2>
            <div class="instructions">
                <p>Find the missing letters from two provided words to form a new word: the Missing Link.</p>
                
                <ul>
                    <li>Type a guess that completes the left and right words with actual words. The solution will be a real word, but your guess does not have to be.</li>
                    
                    <li>After each guess, the tiles will change color to show how close you are:
                        <div style="margin-top: 10px;">
                            <div style="margin-bottom: 10px;"><span class="color-example green"></span> <strong>Green</strong> = Correct letter in the correct position</div>
                            <div style="margin-bottom: 10px;"><span class="color-example yellow"></span> <strong>Yellow</strong> = Correct letter in the wrong position</div>
                            <div><span class="color-example gray"></span> <strong>Gray</strong> = Letter not in the answer</div>
                        </div>
                    </li>
                </ul>
            </div>
            <button onclick="closeHowToPlay()">Got it!</button>
        </div>
    </div>

    <script>
        // Game state
        let DICTIONARY = null;
        let PUZZLES = null;
        let currentPuzzle;
        let currentPuzzleNumber;
        let currentRow = 0;
        let currentGuess = [];
        let gameState = 'playing';
        let keyboardState = {};
        let gameResults = []; // Store results for sharing
        let gameComplete = false; // Track if game has been completed

        // Add debounce tracking for keyboard events
        let lastKeyTime = 0;
        let lastKey = '';

        async function loadGameData() {
            // Load dictionary
            try {
                const dictResponse = await fetch('dict.txt');
                if (dictResponse.ok) {
                    const text = await dictResponse.text();
                    DICTIONARY = text.trim().split('\n').map(word => word.trim().toUpperCase());
                    console.log('Dictionary loaded successfully with', DICTIONARY.length, 'words');
                } else {
                    throw new Error('Failed to fetch dictionary');
                }
            } catch (error) {
                console.log('Dictionary file not found - accepting all 5-letter words');
                DICTIONARY = null;
            }

       // Load puzzles
            try {
                console.log('Attempting to load orbit_puzzles.js...');
                const puzzleResponse = await fetch('orbit_puzzles.js');
                console.log('Puzzle response status:', puzzleResponse.status);
                
                if (puzzleResponse.ok) {
                    const puzzleText = await puzzleResponse.text();
                    console.log('Puzzle file content length:', puzzleText.length);
                    
                    // Try to extract ORBIT_PUZZLES directly from the text
                    const puzzleMatch = puzzleText.match(/const ORBIT_PUZZLES = (\[[\s\S]*?\]);/);
                    if (puzzleMatch) {
                        console.log('Found ORBIT_PUZZLES in file');
                        try {
                            PUZZLES = eval(puzzleMatch[1]);
                            console.log('Puzzles loaded successfully:', PUZZLES.length, 'puzzles');
                        } catch (evalError) {
                            console.log('Error evaluating puzzles:', evalError);
                            throw new Error('Failed to parse puzzles');
                        }
                    } else {
                        // Fallback: try executing the script
                        console.log('Trying script execution method...');
                        const scriptElement = document.createElement('script');
                        scriptElement.textContent = puzzleText;
                        document.head.appendChild(scriptElement);
                        
                        // ORBIT_PUZZLES should now be available globally
                        if (typeof ORBIT_PUZZLES !== 'undefined') {
                            PUZZLES = ORBIT_PUZZLES;
                            console.log('Puzzles loaded via script execution:', PUZZLES.length, 'puzzles');
                        } else {
                            throw new Error('ORBIT_PUZZLES not found after script execution');
                        }
                        
                        // Clean up script element
                        document.head.removeChild(scriptElement);
                    }
                } else {
                    console.log('Failed to fetch puzzles.js, status:', puzzleResponse.status);
                    throw new Error('Failed to fetch puzzles');
                }
            } catch (error) {
                console.log('Puzzle file loading failed, using fallback puzzles. Error:', error);
                // Fallback puzzles if file can't be loaded
                PUZZLES = [
                    { left: 'GHOST', right: 'ARTSY', answer: 'START', leftMissing: 2, rightMissing: 3 },
                    { left: 'GREAT', right: 'ENDED', answer: 'EATEN', leftMissing: 3, rightMissing: 2 },
                    { left: 'NACHO', right: 'SERVE', answer: 'CHOSE', leftMissing: 3, rightMissing: 2 },
                    { left: 'GOLEM', right: 'URGED', answer: 'LEMUR', leftMissing: 3, rightMissing: 2 },
                    { left: 'STARE', right: 'ACHED', answer: 'REACH', leftMissing: 2, rightMissing: 3 }
                ];
                console.log('Using fallback puzzles:', PUZZLES.length, 'puzzles');
            }

            console.log('Initializing game...');

            initGame();
        }

        function initGame() {
            if (!PUZZLES || PUZZLES.length === 0) {
                console.error('No puzzles available');
                return;
            }

            const puzzleIndex = Math.floor(Math.random() * PUZZLES.length);
            currentPuzzle = PUZZLES[puzzleIndex];
            currentPuzzleNumber = 1001 + puzzleIndex; // Assign puzzle number based on index
            currentRow = 0;
            currentGuess = [];
            gameState = 'playing';
            keyboardState = {};
            gameResults = [];
            gameComplete = false;
            
            // Reset keyboard colors
            document.querySelectorAll('.key').forEach(key => {
                key.classList.remove('correct', 'present', 'absent');
            });
            
            // Update puzzle number display
            document.getElementById('puzzleNumber').textContent = `Puzzle #${currentPuzzleNumber}`;
            
            // Disable view results button for new game
            const viewResultsButton = document.getElementById('viewResultsButton');
            viewResultsButton.disabled = true;
            
            displayPuzzle();
            createBoard();
            setupKeyboard();
            
            document.getElementById('gameOverModal').style.display = 'none';
        }

        function displayPuzzle() {
            const leftWord = document.getElementById('leftWord');
            const rightWord = document.getElementById('rightWord');
            
            leftWord.innerHTML = '';
            rightWord.innerHTML = '';
            
            // Display left word
            for (let i = 0; i < 5; i++) {
                const box = document.createElement('div');
                box.className = 'letter-box';
                
                if (i < 5 - currentPuzzle.leftMissing) {
                    box.textContent = currentPuzzle.left[i];
                    box.classList.add('filled');
                } else {
                    box.classList.add('empty');
                }
                
                leftWord.appendChild(box);
            }
            
            // Display right word
            for (let i = 0; i < 5; i++) {
                const box = document.createElement('div');
                box.className = 'letter-box';
                
                if (i >= currentPuzzle.rightMissing) {
                    box.textContent = currentPuzzle.right[i];
                    box.classList.add('filled');
                } else {
                    box.classList.add('empty');
                }
                
                rightWord.appendChild(box);
            }
        }

        function createBoard() {
            const board = document.getElementById('board');
            board.innerHTML = '';
            
            const leftPrefix = currentPuzzle.left.substring(0, 5 - currentPuzzle.leftMissing);
            const rightSuffix = currentPuzzle.right.substring(currentPuzzle.rightMissing);
            
            for (let i = 0; i < 6; i++) {
                const rowContainer = document.createElement('div');
                rowContainer.className = 'guess-row-container';
                
                // Left orbit letters
                const leftOrbit = document.createElement('div');
                leftOrbit.className = 'orbit-letters';
                for (let j = 0; j < leftPrefix.length; j++) {
                    const letter = document.createElement('div');
                    letter.className = 'orbit-letter';
                    letter.textContent = leftPrefix[j];
                    leftOrbit.appendChild(letter);
                }
                
                // Main guess row with separator
                const row = document.createElement('div');
                row.className = 'guess-row';
                row.id = `row-${i}`;
                
                // Add tiles for left word portion
                for (let j = 0; j < currentPuzzle.leftMissing; j++) {
                    const tile = document.createElement('div');
                    tile.className = 'tile';
                    tile.id = `tile-${i}-${j}`;
                    row.appendChild(tile);
                }
                
                // Add separator
                const separator = document.createElement('div');
                separator.className = 'orbit-letter';
                separator.style.width = '15px';
                separator.style.paddingTop = '10px';
                separator.innerHTML = '&bull;';
                row.appendChild(separator);
                
                // Add tiles for right word portion
                for (let j = currentPuzzle.leftMissing; j < currentPuzzle.answer.length; j++) {
                    const tile = document.createElement('div');
                    tile.className = 'tile';
                    tile.id = `tile-${i}-${j}`;
                    row.appendChild(tile);
                }
                
                // Right orbit letters
                const rightOrbit = document.createElement('div');
                rightOrbit.className = 'orbit-letters';
                for (let j = 0; j < rightSuffix.length; j++) {
                    const letter = document.createElement('div');
                    letter.className = 'orbit-letter';
                    letter.textContent = rightSuffix[j];
                    rightOrbit.appendChild(letter);
                }
                
                rowContainer.appendChild(leftOrbit);
                rowContainer.appendChild(row);
                rowContainer.appendChild(rightOrbit);
                board.appendChild(rowContainer);
            }
        }

        function setupKeyboard() {
            // On-screen keyboard
            document.querySelectorAll('.key').forEach(button => {
                button.addEventListener('click', () => handleKey(button.dataset.key));
            });
            
            // Physical keyboard with debouncing
            document.addEventListener('keydown', (e) => {
                if (gameState !== 'playing') return;
                
                const currentTime = Date.now();
                const key = e.key;
                
                // Debounce: ignore if same key pressed within 100ms
                if (key === lastKey && currentTime - lastKeyTime < 100) {
                    e.preventDefault();
                    e.stopPropagation();
                    return;
                }
                
                lastKey = key;
                lastKeyTime = currentTime;
                
                // Prevent default for keys we handle
                if (key === 'Enter' || key === 'Backspace' || /^[a-zA-Z]$/.test(key)) {
                    e.preventDefault();
                    e.stopPropagation();
                }
                
                if (key === 'Enter') {
                    handleKey('Enter');
                } else if (key === 'Backspace') {
                    handleKey('Backspace');
                } else if (/^[a-zA-Z]$/.test(key)) {
                    handleKey(key.toUpperCase());
                }
            });

            // Also handle keyup to reset debounce faster
            document.addEventListener('keyup', (e) => {
                if (e.key === lastKey) {
                    lastKey = '';
                }
            });
        }

        function handleKey(key) {
            if (gameState !== 'playing') return;
            
            if (key === 'Enter') {
                submitGuess();
            } else if (key === 'Backspace') {
                deleteLetter();
            } else if (/^[A-Z]$/.test(key)) {
                addLetter(key);
            }
        }

        function addLetter(letter) {
            if (currentGuess.length < currentPuzzle.answer.length) {
                currentGuess.push(letter);
                updateCurrentRow();
            }
        }

        function deleteLetter() {
            if (currentGuess.length > 0) {
                currentGuess.pop();
                updateCurrentRow();
            }
        }

        function updateCurrentRow() {
            for (let i = 0; i < currentPuzzle.answer.length; i++) {
                const tile = document.getElementById(`tile-${currentRow}-${i}`);
                if (i < currentGuess.length) {
                    tile.textContent = currentGuess[i];
                    tile.classList.add('filled');
                } else {
                    tile.textContent = '';
                    tile.classList.remove('filled');
                }
            }
        }

        function submitGuess() {
            if (currentGuess.length !== currentPuzzle.answer.length) {
                showMessage('Not enough letters', 'error');
                return;
            }
            
            const guessString = currentGuess.join('');
            
            // Build complete words
            const leftPrefix = currentPuzzle.left.substring(0, 5 - currentPuzzle.leftMissing);
            const rightSuffix = currentPuzzle.right.substring(currentPuzzle.rightMissing);
            
            const leftWord = leftPrefix + guessString.substring(0, currentPuzzle.leftMissing);
            const rightWord = guessString.substring(currentPuzzle.leftMissing) + rightSuffix;
            
            // Validate words
            if (!isValidWord(leftWord)) {
                showMessage(`"${leftWord}" is not a valid word`, 'error');
                shakeRow();
                return;
            }
            
            if (!isValidWord(rightWord)) {
                showMessage(`"${rightWord}" is not a valid word`, 'error');
                shakeRow();
                return;
            }
            
            // Evaluate guess
            const evaluation = evaluateGuess();
            gameResults.push(evaluation);
            
            // Check win/loss after animation completes
            setTimeout(() => {
                if (guessString === currentPuzzle.answer) {
                    gameState = 'won';
                    showGameOver(true);
                } else if (currentRow === 5) {
                    gameState = 'lost';
                    showGameOver(false);
                } else {
                    currentRow++;
                    currentGuess = [];
                }
            }, currentPuzzle.answer.length * 200 + 200);
        }

        function isValidWord(word) {
            if (DICTIONARY === null) {
                return word.length === 5;
            }
            return DICTIONARY.includes(word);
        }

        function evaluateGuess() {
            const guess = currentGuess.join('');
            const answer = currentPuzzle.answer;
            const evaluation = [];
            const answerArray = answer.split('');
            const guessArray = guess.split('');
            const rowToEvaluate = currentRow; // Capture current row
            
            // First pass: mark correct letters
            for (let i = 0; i < guess.length; i++) {
                if (guessArray[i] === answerArray[i]) {
                    evaluation[i] = 'correct';
                    answerArray[i] = null;
                    guessArray[i] = null;
                }
            }
            
            // Second pass: mark present letters
            for (let i = 0; i < guess.length; i++) {
                if (guessArray[i] !== null) {
                    const index = answerArray.indexOf(guessArray[i]);
                    if (index !== -1) {
                        evaluation[i] = 'present';
                        answerArray[index] = null;
                    } else {
                        evaluation[i] = 'absent';
                    }
                }
            }
            
            // Update tiles with animation delay
            evaluation.forEach((result, i) => {
                setTimeout(() => {
                    const tile = document.getElementById(`tile-${rowToEvaluate}-${i}`);
                    tile.classList.remove('filled');
                    tile.classList.add(result);
                    
                    // Update keyboard
                    const letter = currentGuess[i];
                    const key = document.querySelector(`[data-key="${letter}"]`);
                    if (key) {
                        if (!keyboardState[letter] || 
                            (keyboardState[letter] === 'present' && result === 'correct') ||
                            (keyboardState[letter] === 'absent' && result !== 'absent')) {
                            keyboardState[letter] = result;
                            key.classList.remove('correct', 'present', 'absent');
                            key.classList.add(result);
                        }
                    }
                }, i * 200); // Changed to 200ms (doubled from original 100ms)
            });

            return evaluation;
        }

        function shakeRow() {
            const rowContainer = document.querySelector(`#row-${currentRow}`).parentElement;
            rowContainer.style.animation = 'shake 0.5s';
            setTimeout(() => {
                rowContainer.style.animation = '';
            }, 500);
        }

        function showMessage(text, type) {
            const existingMessage = document.querySelector('.message');
            if (existingMessage) {
                existingMessage.remove();
            }
            
            const message = document.createElement('div');
            message.className = `message ${type}`;
            message.textContent = text;
            document.body.appendChild(message);
            
            setTimeout(() => {
                message.remove();
            }, 2000);
        }

        function generateShareText() {
            const resultLine = gameState === 'won' 
                ? `Orbit ${currentPuzzleNumber} ${currentRow + 1}/6`
                : `Orbit ${currentPuzzleNumber} X/6`;
            
            let shareText = resultLine + '\n\n';
            
            // Convert results to emoji grid
            gameResults.forEach(evaluation => {
                let line = '';
                
                // Add squares for left word portion
                for (let i = 0; i < currentPuzzle.leftMissing; i++) {
                    if (evaluation[i] === 'correct') {
                        line += '🟩';
                    } else if (evaluation[i] === 'present') {
                        line += '🟨';
                    } else {
                        line += '⬜';
                    }
                }
                
                // Add bullet separator
                line += '•';
                
                // Add squares for right word portion
                for (let i = currentPuzzle.leftMissing; i < currentPuzzle.answer.length; i++) {
                    if (evaluation[i] === 'correct') {
                        line += '🟩';
                    } else if (evaluation[i] === 'present') {
                        line += '🟨';
                    } else {
                        line += '⬜';
                    }
                }
                
                shareText += line + '\n';
            });
            
            return shareText.trim();
        }

        function showGameOver(won) {
            const modal = document.getElementById('gameOverModal');
            const title = document.getElementById('modalTitle');
            const message = document.getElementById('modalMessage');
            const shareResult = document.getElementById('shareResult');
            const shareButton = document.getElementById('shareButton');
            const viewResultsButton = document.getElementById('viewResultsButton');
            
            gameComplete = true;
            viewResultsButton.disabled = false; // Enable the view results button
            
            if (won) {
                title.textContent = 'Way to go!';
                message.textContent = `You found the Missing Link in ${currentRow + 1} ${currentRow === 0 ? 'guess' : 'guesses'}!`;
            } else {
                title.textContent = 'Better luck next time!';
                message.textContent = `The answer was: ${currentPuzzle.answer}`;
            }
            
            // Generate and show share result
            const shareText = generateShareText();
            shareResult.textContent = shareText;
            shareResult.style.display = 'block';
            shareButton.style.display = 'inline-block';
            
            modal.style.display = 'flex';
        }

        function shareResult() {
            const shareText = generateShareText();
            
            if (navigator.share) {
                navigator.share({
                    title: 'Orbit Puzzle',
                    text: shareText
                }).catch(err => {
                    console.log('Share failed:', err);
                    // Fallback to copy
                    copyResult();
                });
            } else {
                // Fallback to copy
                copyResult();
            }
        }

        function copyResult() {
            const shareText = generateShareText();
            
            if (navigator.clipboard) {
                navigator.clipboard.writeText(shareText).then(() => {
                    showMessage('Results copied to clipboard!', 'success');
                }).catch(err => {
                    console.log('Copy failed:', err);
                    fallbackCopy();
                });
            } else {
                fallbackCopy();
            }
        }

        function fallbackCopy() {
            // Fallback: select the text
            const shareResult = document.getElementById('shareResult');
            const range = document.createRange();
            range.selectNodeContents(shareResult);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            
            try {
                document.execCommand('copy');
                showMessage('Results copied to clipboard!', 'success');
            } catch (err) {
                showMessage('Results selected - copy with Ctrl+C', 'info');
            }
        }

        function showResults() {
            if (!gameComplete) return;
            
            // Show the existing game over modal with results
            const modal = document.getElementById('gameOverModal');
            modal.style.display = 'flex';
        }

        function closeResults() {
            const modal = document.getElementById('gameOverModal');
            modal.style.display = 'none';
        }

        function newGame() {
            initGame();
        }

        function showHowToPlay() {
            document.getElementById('howToPlayModal').style.display = 'flex';
        }

        function closeHowToPlay() {
            document.getElementById('howToPlayModal').style.display = 'none';
        }

        // Initialize game on load
        loadGameData();
    </script>
</body>
</html>
